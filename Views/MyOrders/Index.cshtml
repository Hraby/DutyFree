@{
    ViewData["Title"] = "Moje objednávky";
}


<section class="hero2">
    <div class="container">
        <h1 class="display-4 text-white text-center"><strong>Moje objednávky</strong></h1>
    </div>
</section>

<div class="container">
    <section class="dates">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="datumOd">Datum (od)</label>
                    <input type="date" id="datumOd" name="datumOd" class="form-control rounded-0" lang="cs">
                </div>
            </div>
            <div class="col-md-6"></div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="datumDo">Datum (do)</label>
                    <input type="date" id="datumDo" name="datumDo" class="form-control rounded-0" lang="cs">
                </div>
            </div>
        </div>
    </section>

    <div class="col-md-6">
        <div class="form-group">
            <button type="button" id="resetButton" class="btn rounded-0">Obnovit</button>
        </div>
    </div>



    <table class="table table-hover" id="TableToExport">
        <thead>
            <tr>
                <th>Datum</th>
                <th>Čas</th>
                <th>Produkt</th>
                <th>Cena (Kč)</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model.Orders)
            {
            <tr>
                <td>@order.DateCreatedCZ.ToString("dd.MM.yyyy")</td>
                <td>@order.DateCreatedCZ.ToString("HH:mm")</td>
                <td>@order.Name</td>
                <td>@order.Price</td>
                <td>
                    <span class="cancel-icon" onclick="cancelOrder(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#FF4401" class="bi bi-x" viewBox="0 0 16 16" cursor="pointer">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                        </svg>
                    </span>
                    <input type="hidden" value="@order.OrderId"/>
                    <input type="hidden" class="dateCreated" value="@order.DateCreatedCZ">
                </td>
            </tr>
            }
        </tbody>
        <tfoot>
        <tr>
            <td colspan="4" class="text-left">Cena celkem:</td>
            <td id="celkovaCena">0 Kč</td>
        </tr>
        </tfoot>
    </table>
    
    <button type="button" id="sheetjsexport" class="btn rounded-0">Export</button>

</div>

<div class="notification-container"></div>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.getElementById("sheetjsexport").addEventListener('click', function() {
      var wb = XLSX.utils.table_to_book(document.getElementById("TableToExport"));
      XLSX.writeFile(wb, "DutyFree-objednavky.xlsx");
    });

    // Zrušení objednávky
    function cancelOrder(element) {
        var row = $(element).closest('tr');
        var orderId = row.find("input[type=hidden]").val();
        console.log(orderId);
        var data = { orderId: orderId };
        row.remove();
        updateTotalPrice();
        createNotification('Produkt byl úspěšně odebrán!');
        $.ajax({
            url: '@Url.Action("Delete", "MyOrders")',
            type: 'DELETE',
            dataType: 'json',
            data: $.param(data),
            contentType: 'application/x-www-form-urlencoded'
        });
    }

    // Vytvoření notifikace
    function createNotification(message, color) {
        var notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.backgroundColor = color;

        var closeBtn = document.createElement('span');
        closeBtn.className = 'close';
        closeBtn.innerHTML = '&times;';
        notification.appendChild(closeBtn);

        var content = document.createElement('p');
        content.innerHTML = message;
        notification.appendChild(content);

        $(".notification-container").append(notification);

        // Odstranění notifikace s animací fade-out
        var fadeOutAnimation = setTimeout(function () {
            $(notification).fadeOut(500, function () {
                $(this).remove();
            });
        }, 3000);

        // Odstranění notifikace po kliknutí na křížek
        $(closeBtn).click(function () {
            clearTimeout(fadeOutAnimation);
            $(notification).fadeOut(500, function () {
                $(this).remove();
            });
        });
    }

    // Aktualizace celkové ceny
    function updateTotalPrice() {
        var table = document.querySelector(".table");
        var rows = table.querySelectorAll("tbody tr");
        var totalPrice = 0;

        rows.forEach(function (row) {
            var priceCell = row.querySelector("td:nth-child(4)");
            var price = parseFloat(priceCell.innerText);
            totalPrice += price;
        });

        var totalCell = document.getElementById("celkovaCena");
        totalCell.innerHTML = totalPrice.toFixed(2) + " Kč";
    }

    window.onload = function () {
        // Defaultní nastavení prvního dne v měsíci
        var currentDate = new Date();
        currentDate.setDate(1);
        var firstDayOfMonth = currentDate.toISOString().slice(0, 10);
        document.getElementById("datumOd").value = firstDayOfMonth;

        // Defaultní nastavení aktuálního datumu
        var currentDate = new Date().toISOString().slice(0, 10);
        document.getElementById("datumDo").value = currentDate;
        
        // Validace datumu objednávky
        var tableRows = document.querySelectorAll(".table tbody tr");
        var twentyFourHoursAgo = new Date();
        twentyFourHoursAgo.setDate(twentyFourHoursAgo.getDate() - 1);

        tableRows.forEach(function (row) {
            var dateInput = row.querySelector(".dateCreated");
            var orderDate = new Date(dateInput.value.replace(/(\d{2}).(\d{2}).(\d{4})/, "$2/$1/$3"));
            console.log(orderDate + " " + twentyFourHoursAgo)

            if (orderDate > twentyFourHoursAgo) {
                var cancelIcon = row.querySelector(".cancel-icon");
                cancelIcon.style.display = "inline-block";
            } else {
                var cancelIcon = row.querySelector(".cancel-icon");
                cancelIcon.style.display = "none";
            }
        });

        updateTotalPrice();
    };


    document.getElementById("resetButton").addEventListener("click", function () {
        resetOrders();
    });

    // Přidání události input pro fromDate
    document.getElementById("datumOd").addEventListener("input", function () {
        filterOrders();
    });

    // Přidání události input pro toDate
    document.getElementById("datumDo").addEventListener("input", function () {
        filterOrders();
    });

    // Filtrování objednávek na základě časového rozmezí
    function filterOrders() {
        var fromDate = new Date(document.getElementById("datumOd").value);
        var toDate = new Date(document.getElementById("datumDo").value);

        // Validace časového úseku, prohození datumů
        if (fromDate > toDate) {
            var tempDate = fromDate;
            fromDate = toDate;
            toDate = tempDate;

            document.getElementById("datumOd").value = fromDate.toISOString().slice(0, 10);
            document.getElementById("datumDo").value = toDate.toISOString().slice(0, 10);
        }

        var tableRows = document.querySelectorAll(".table tbody tr");

        tableRows.forEach(function (row) {
            var dateCell = row.querySelector("td:first-child");
            var orderDate = new Date(dateCell.innerText.split(".").reverse().join("-"));

            if (orderDate >= fromDate && orderDate <= toDate) {
                row.style.display = "table-row";
            } else {
                row.style.display = "none";
            }
        });

        updateTotalPrice();
        calculateTotalPrice();
    }

    // Přepočítání ceny při aktivování filtru
    function calculateTotalPrice() {
        var totalPrice = 0;

        var filteredRows = document.querySelectorAll(".table tbody tr[style='display: table-row;']");

        filteredRows.forEach(function (row) {
            var priceCell = row.querySelector("td:nth-child(4)");
            var price = parseFloat(priceCell.innerText);
            totalPrice += price;
        });

        var totalCell = document.getElementById("celkovaCena");
        totalCell.innerHTML = "<strong>" + totalPrice.toFixed(2) + " Kč</strong>";
    }


    // Resetování filtru
    function resetOrders() {
        var tableRows = document.querySelectorAll(".table tbody tr");

        tableRows.forEach(function (row) {
            row.style.display = "table-row";
        });

        updateTotalPrice();
        calculateTotalPrice();
        
        // Nastavení prvního dne v měsíci a aktuálního data
        var currentDate = new Date();
        currentDate.setDate(1);
        var firstDayOfMonth = currentDate.toISOString().slice(0, 10);

        document.getElementById("datumOd").value = firstDayOfMonth;


        var currentDate = new Date().toISOString().slice(0, 10);
        document.getElementById("datumDo").value = currentDate;
    }


</script>

<style>
    ::selection
    {
        background-color: #FF4401;
        color: white;
        }

    .hero2 {
        background-image: url('https://media.discordapp.net/attachments/1107599847562952794/1107974604867244072/photo-login.png?width=1600&height=842');
        background-size: cover;
        background-position: center;
        border-bottom: 6px solid #FF4401;
        width: 100%;
        height: 30vh;
        display: flex;
        align-items: center;
    }

    .dates {
        margin-top: 20px;
    }

    .btn
    {
        margin-top: 2%;
        margin-bottom: 2%;
        background-color: white;
        color: #FF4401;
        border-color: #FF4401;
    }

    .btn:hover
    {
        background-color: #FF4401;
        color: white;
        border-color: #FF4401;
    } 

    .notification-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        width: 300px;
        max-width: calc(100% - 40px);
    }

    .notification {
        position: relative;
        padding: 10px;
        background-color: #28a745;
        color: #fff;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        animation: slide-in 0.3s ease-in-out;
        margin-bottom: 10px;
    }

        .notification .close {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: #fff;
        }
</style>
